// NEXTFLOW MANIFEST
manifest {
    name                                  = 'umi-pipeline-nf'
    version                               = '0.2.1'
    description                           = 'Nextflow pipeline to analyze umi amplicon data'
    author                                = 'Stephan Amstler'
    homePage                              = 'https://github.com/AmstlerStephan/umi-pipeline-nf.git'
    mainScript                            = 'main.nf'
    nextflowVersion                       = '!>=22.04'
}

// DEFAULT PARAMETERS
params {

    // BASIC PARAMS
    help                                  = false
    version                               = false
    debug                                 = false
    
    // GENERAL - Required    
    input                                 = null
    output                                = null
    reference                             = null
    reference_fai                         = null
    bed                                   = null
    
    //READ FILTERING
    min_read_length                       = 0
    min_qscore                            = 0

    // SUBSAMPLING
    subsampling                           = false
    subsampling_seed                      = 11
    subsampling_readnumber                = 100000
    
    // VARIANT_CALLING
    call_variants                         = false    
    variant_caller                        = null

    // ADVANCED
    min_reads_per_barcode                 = 1000
    umi_errors                            = 2
    max_dist_umi                          = 2
    min_reads_per_cluster                 = 20
    max_reads_per_cluster                 = 60
    min_consensus_quality                 = 40
    masking_strategy                      = "softmask"
    filter_strategy_clusters              = "quality"
    output_format                         = "fastq"
    write_reports                         = true
    min_overlap                           = 0.95
    include_secondary_reads               = false
    balance_strands                       = true
    use_gpu                               = false
    gpu_memory                            = 16
    gpus                                  = "all"
    medaka_model                          = "r1041_e82_400bps_hac_g615"
    fwd_umi                               = "TTTVVVVTTVVVVTTVVVVTTVVVVTTT"
    rev_umi                               = "AAABBBBAABBBBAABBBBAABBBBAAA"
    adapter_length                        = 100
    min_length                            = 40
    max_length                            = 60
    minimap2_param                        = "-ax map-ont -k 13 --MD"
    threads                               = (Runtime.runtime.availableProcessors() - 1)
}


// NEXTFLOW PROFILES

// Load base.config by default for all pipelines
includeConfig "config/base.config"

process.container = 'quay.io/genepi/umi-pipeline-nf:v0.2.1'

profiles {

    conda {
        process.conda                        = "env/environment.yml"
    }

    docker {
        docker.enabled                       = true
    }

    singularity {
        singularity.enabled                   = true
        singularity.autoMounts                = true
        docker.enabled                        = false
    }

    test {
        includeConfig "config/test.config"
    }

    custom {
        includeConfig "config/custom.config"
    }

}

/*
if(params.use_gpu){
    println("use GPU")
    process {
        container                         = 'quay.io/genepi/umi-pipeline-nf:v0.2.1'
        withLabel: gpu_possible {
            container = 'ontresearch/medaka:latest'
            // Set environment variables
            // docker.envWhitelist = "TF_FORCE_GPU_ALLOW_GROWTH = true"
            docker.runOptions = "--rm --gpus ${params.gpus}"
            docker.runOptions = "--rm --gpus all"
            println("All set")
        }
    }
}
*/