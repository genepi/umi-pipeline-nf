nextflow_process {

    name "Test Process FREEBAYES"
    script "modules/local/variant_calling/freebayes.nf"
    process "FREEBAYES"

    test("Should run without failures") {

        when {
            params {
                variant_calling = true 
                variant_caller = "freebayes"
            }
            process {
                """
                input[0] = Channel.of(
                    ["barcode03", "final", "$baseDir/tests/input/variant_calling/barcode03/final.bam", "$baseDir/tests/input/variant_calling/barcode03/final.bam.bai"]
                    )
                input[1] = "final"
                input[2] = file("$baseDir/tests/input/pipeline/ref/lpa-ref2645.fasta")
                input[3] = file("$baseDir/tests/input/pipeline/ref/lpa-ref2645.fasta.fai")
                """
            }
        }

        then {
            assert process.success
            with(process.out.variants){
                assert path(get(0)).vcf.summary == path("$baseDir/tests/validation/freebayes/barcode03/final.vcf").vcf.summary
            }
        }
    }

    test("Should output three files") {

        when {
            params {
                variant_calling = true 
                variant_caller = "freebayes"
            }
            process {
                """
                input[0] = Channel.of(
                    ["barcode03", "final", "$baseDir/tests/input/variant_calling/barcode03/final.bam", "$baseDir/tests/input/variant_calling/barcode03/final.bam.bai"],
                    ["barcode04", "final", "$baseDir/tests/input/variant_calling/barcode04/final.bam", "$baseDir/tests/input/variant_calling/barcode04/final.bam.bai"],
                    ["barcode05", "final", "$baseDir/tests/input/variant_calling/barcode05/final.bam", "$baseDir/tests/input/variant_calling/barcode05/final.bam.bai"]
                    )
                input[1] = "final"
                input[2] = file("$baseDir/tests/input/pipeline/ref/lpa-ref2645.fasta")
                input[3] = file("$baseDir/tests/input/pipeline/ref/lpa-ref2645.fasta.fai")
                """
            }
        }

        then {
            assert process.success
            with(process.out.variants){
                assert path(get(0).get(1)).vcf.summary == path("$baseDir/tests/validation/freebayes/${get(0).get(0)}/final.vcf").vcf.summary
                assert path(get(1).get(1)).vcf.summary == path("$baseDir/tests/validation/freebayes/${get(1).get(0)}/final.vcf").vcf.summary
                assert path(get(2).get(1)).vcf.summary == path("$baseDir/tests/validation/freebayes/${get(2).get(0)}/final.vcf").vcf.summary
            }
        }

    }
}
